<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¹´é–“å®¶è¨ˆæ¯”è¼ƒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);min-height:100vh;color:#2d3748}
    .header{background:linear-gradient(135deg,#1a202c 0%,#2d3748 100%);color:#fff;padding:30px 20px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .header h1{font-size:2.5rem;margin-bottom:10px;font-weight:700}
    .header p{opacity:.8;font-size:1.1rem}
    .year-selector{background:#fff;padding:20px;margin:20px;border-radius:15px;box-shadow:0 4px 6px rgba(0,0,0,.1);text-align:center}
    .year-buttons{display:flex;justify-content:center;gap:15px;flex-wrap:wrap}
    .year-btn{background:linear-gradient(135deg,#4299e1 0%,#3182ce 100%);color:#fff;border:none;padding:12px 24px;border-radius:25px;cursor:pointer;font-size:16px;font-weight:600;transition:.3s;min-width:100px}
    .year-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(66,153,225,.4)}
    .year-btn.active{background:linear-gradient(135deg,#38a169 0%,#2f855a 100%)}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(600px,1fr));gap:30px}
    .category-section{background:#fff;border-radius:20px;box-shadow:0 8px 25px rgba(0,0,0,.1);overflow:hidden;transition:transform .3s}
    .category-section:hover{transform:translateY(-5px)}
    .category-header{padding:25px 30px;color:#fff;position:relative;overflow:hidden; display:flex; align-items:center; justify-content:space-between; text-align:left}
    .header-left{ display:flex; align-items:center; gap:12px; } /* â† è¿½åŠ  */
    .category-header .icon{ font-size:2.2rem; margin:0; display:block; } /* æ—¢å­˜ã‚’å¾®èª¿æ•´ */
    .header-meta{ text-align:right; font-weight:700; line-height:1.35; } /* â† è¿½åŠ  */
    .header-meta small{ display:block; opacity:.9; font-weight:600; }     /* â† è¿½åŠ  */
    .category-header::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}
    .category-section:hover .category-header::before{left:100%}
    .food-header{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)}
    .electric-header{background:linear-gradient(135deg,#feca57 0%,#ff9f43 100%)}
    .gas-header{background:linear-gradient(135deg,#48cae4 0%,#0077b6 100%)}
    .water-header{background:linear-gradient(135deg,#4ecdc4 0%,#44a08d 100%)}
    .category-header h2{font-size:1.8rem;margin-bottom:8px;font-weight:700}
    .category-header .icon{font-size:2.5rem;margin-bottom:10px;display:block}
    .category-content{padding:30px}
    .chart-container{position:relative;height:420px} /* å°‘ã—å¤§ãã‚ã« */
    .loading{text-align:center;padding:40px;color:#718096}
    .error{background:#fed7d7;color:#9b2c2c;padding:20px;border-radius:10px;margin:20px;text-align:center}
    .summary-stats{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:25px;border-radius:15px;margin:30px 20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}
    .stat-item{text-align:center}.stat-value{font-size:2rem;font-weight:700;margin-bottom:5px}.stat-label{font-size:.9rem;opacity:.9}
    @media (max-width:768px){.dashboard{grid-template-columns:1fr}.header h1{font-size:2rem}}
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“Š å¹´é–“å®¶è¨ˆæ¯”è¼ƒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p>GoogleSpreadsheeté€£æº - å…‰ç†±è²»ãƒ»é£Ÿè²»ã®å‰å¹´æ¯”è¼ƒåˆ†æ</p>
  </div>

  <div class="year-selector">
    <h3 style="margin-bottom:15px;color:#2d3748;">è¡¨ç¤ºå¹´åº¦ã‚’é¸æŠ</h3>
    <div class="year-buttons" id="yearButtons"></div>
  </div>

  <div class="summary-stats" id="summaryStats" style="display:none;">
    <div class="stat-item"><div class="stat-value" id="totalCurrentYear">Â¥0</div><div class="stat-label">ä»Šå¹´åº¦ç·æ”¯å‡º</div></div>
    <div class="stat-item"><div class="stat-value" id="totalPreviousYear">Â¥0</div><div class="stat-label">å‰å¹´åº¦ç·æ”¯å‡º</div></div>
    <div class="stat-item"><div class="stat-value" id="averageMonthly">Â¥0</div><div class="stat-label">æœˆå¹³å‡æ”¯å‡º</div></div>
    <div class="stat-item"><div class="stat-value" id="yearlyComparison">0%</div><div class="stat-label">å‰å¹´æ¯”</div></div>
  </div>

  <div class="container">
    <div id="loadingMessage" class="loading">
      <h3>ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</h3>
      <p>GoogleSpreadsheetã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™</p>
    </div>
    <div id="errorMessage" class="error" style="display:none;">
      <h3>âŒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
      <p>GoogleSpreadsheetã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
    </div>

    <div class="dashboard" id="dashboard" style="display:none;">
      <!-- é£Ÿè²» -->
      <div class="category-section">
        <div class="category-header food-header">
          <span class="icon">ğŸ½ï¸</span><h2>é£Ÿè²»</h2>
        </div>
        <div class="category-content">
          <div class="chart-container"><canvas id="foodChart"></canvas></div>
        </div>
      </div>
      <!-- é›»æ°—ä»£ -->
      <div class="category-section">
        <div class="category-header electric-header">
          <span class="icon">âš¡</span><h2>é›»æ°—ä»£</h2>
        </div>
        <div class="category-content">
          <div class="chart-container"><canvas id="electricChart"></canvas></div>
        </div>
      </div>
      <!-- ã‚¬ã‚¹ä»£ -->
      <div class="category-section">
        <div class="category-header gas-header">
          <span class="icon">ğŸ”¥</span><h2>ã‚¬ã‚¹ä»£</h2>
        </div>
        <div class="category-content">
          <div class="chart-container"><canvas id="gasChart"></canvas></div>
        </div>
      </div>
      <!-- æ°´é“ä»£ -->
      <div class="category-section">
        <div class="category-header water-header">
          <span class="icon">ğŸ’§</span><h2>æ°´é“ä»£</h2>
        </div>
        <div class="category-content">
          <div class="chart-container"><canvas id="waterChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    class HouseholdDashboard {
      constructor() {
        this.CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-kxUoOhW4-dUlEexnx-eL-NnVu6gM3BAXEc91sn66UEFQKzFzv1BscDWsu4EVl5fTc9g16zMvAyWj/pub?output=csv';
        this.data={};
        this.currentYear=new Date().getFullYear();
        this.charts={};
        this.categories={
          food:{name:'é£Ÿè²»',color:'#ff6b6b'},
          electric:{name:'é›»æ°—ä»£',color:'#feca57'},
          gas:{name:'ã‚¬ã‚¹ä»£',color:'#48cae4'},
          water:{name:'æ°´é“ä»£',color:'#4ecdc4'}
        };
        this.months=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
        this.init();
      }
      toNumber(str){return Number(String(str).replace(/[^\d.-]/g,''))||0;}
      yen(a){return new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(a);}

      async init(){
        try{
          await this.loadFromCSV();
          this.setupYearSelector();
          const years=Object.keys(this.data).map(Number);
          if(years.length) this.currentYear=Math.max(...years);
          this.displayData(this.currentYear);
          this.hideLoading();
        }catch(e){console.error(e);this.showError();}
      }

      parseCSV(text){
        const rows=[];let row=[],cell='',inQuotes=false;
        for(let i=0;i<text.length;i++){
          const c=text[i],n=text[i+1];
          if(inQuotes){
            if(c==='"'&&n==='"'){cell+='"';i++;}
            else if(c==='"'){inQuotes=false;}
            else{cell+=c;}
          }else{
            if(c==='"') inQuotes=true;
            else if(c===','){row.push(cell);cell='';}
            else if(c==='\n'||c==='\r'){if(c==='\r'&&n==='\n') i++;row.push(cell);rows.push(row);row=[];cell='';}
            else{cell+=c;}
          }
        }
        if(cell.length||inQuotes||row.length){row.push(cell);rows.push(row);}
        return rows.filter(r=>r.length&&r.some(v=>v!==''));
      }

      async loadFromCSV(){
        const res=await fetch(this.CSV_URL,{cache:'no-store'});
        if(!res.ok) throw new Error('CSVå–å¾—å¤±æ•—');
        const csv=await res.text();
        const rows=this.parseCSV(csv);
        let start=0;if(rows.length&&isNaN(parseInt(rows[0][0]))) start=1;
        const data={};
        for(let i=start;i<rows.length;i++){
          const [year,month,food,electric,gas,water]=rows[i];
          const y=parseInt(year),m=parseInt(month);
          if(!y||!m) continue;
          if(!data[y]) data[y]={};
          data[y][m]={
            food:this.toNumber(food),
            electric:this.toNumber(electric),
            gas:this.toNumber(gas),
            water:this.toNumber(water)
          };
        }
        this.data=data;
      }

      setupYearSelector(){
        const yearButtons=document.getElementById('yearButtons');
        yearButtons.innerHTML='';
        const years=Object.keys(this.data).map(Number).sort((a,b)=>b-a);
        years.forEach(year=>{
          const btn=document.createElement('button');
          btn.className='year-btn'+(year===this.currentYear?' active':'');
          btn.textContent=`${year}å¹´`;
          btn.addEventListener('click',(e)=>this.selectYear(year,e));
          yearButtons.appendChild(btn);
        });
      }

      selectYear(year,e){
        this.currentYear=year;
        document.querySelectorAll('.year-btn').forEach(b=>b.classList.remove('active'));
        if(e&&e.currentTarget) e.currentTarget.classList.add('active');
        this.displayData(year);
      }

      displayData(year){
        this.updateSummaryStats(year);
        this.createCharts(year);
      }

      updateSummaryStats(year) {
        const cur = this.data[year] || {};
        const prev = this.data[year - 1] || {};

        // â‘  ä»Šå¹´ã®ã€Œãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹æœ€å¾Œã®æœˆã€ã‚’æ±‚ã‚ã‚‹
        let maxMonth = 0;
        for (let m = 1; m <= 12; m++) {
            if (cur[m] && Object.values(cur[m]).some(v => v !== undefined)) maxMonth = m;
        }
        if (maxMonth === 0) maxMonth = 12; // å¿µã®ãŸã‚

        // â‘¡ ç”»é¢ã®åˆè¨ˆè¡¨ç¤ºï¼ˆå¾“æ¥é€šã‚Šï¼šå­˜åœ¨ã™ã‚‹æœˆã®ã¿åˆè¨ˆï¼‰
        let totalCurrent = 0, totalPrevious = 0;
        for (let m = 1; m <= 12; m++) {
            if (cur[m])  totalCurrent  += Object.values(cur[m]).reduce((s, v) => s + v, 0);
            if (prev[m]) totalPrevious += Object.values(prev[m]).reduce((s, v) => s + v, 0);
        }

        // â‘¢ å‰å¹´æ¯”ã®åŸºæº–ã‚’åˆã‚ã›ã‚‹ï¼ˆä»Šå¹´ã®maxMonthã¾ã§ã§æ¯”è¼ƒï¼‰
        let ytdCurrent = 0, ytdPrevious = 0;
        for (let m = 1; m <= maxMonth; m++) {
            if (cur[m])  ytdCurrent  += Object.values(cur[m]).reduce((s, v) => s + v, 0);
            if (prev[m]) ytdPrevious += Object.values(prev[m]).reduce((s, v) => s + v, 0);
        }
        const avgMonthly = ytdCurrent / maxMonth; // å¹³å‡ã¯YTDãƒ™ãƒ¼ã‚¹ã«å¯„ã›ã‚‹ã®ãŒãŠã™ã™ã‚
        const yearlyChange = ytdPrevious > 0 ? ((ytdCurrent - ytdPrevious) / ytdPrevious * 100) : 0;

        // è¡¨ç¤º
        document.getElementById('totalCurrentYear').textContent  = this.yen(totalCurrent);
        document.getElementById('totalPreviousYear').textContent = this.yen(totalPrevious);
        document.getElementById('averageMonthly').textContent    = this.yen(Math.round(avgMonthly));

        const comparisonElement = document.getElementById('yearlyComparison');
        comparisonElement.textContent = `${yearlyChange > 0 ? '+' : ''}${yearlyChange.toFixed(1)}%`;
        comparisonElement.style.color = yearlyChange > 0 ? '#e53e3e' : '#38a169';

        document.getElementById('summaryStats').style.display = 'grid';
      }

      createCharts(year){
        Object.keys(this.categories).forEach(cat=>this.createCategoryChart(cat,year));
      }

      createCategoryChart(category, year) {
  const ctx = document.getElementById(`${category}Chart`).getContext('2d');
  if (this.charts[category]) this.charts[category].destroy();

  const cur = [], prev = [];
  for (let m = 1; m <= 12; m++) {
    cur.push(this.data[year]?.[m]?.[category] || 0);
    prev.push(this.data[year - 1]?.[m]?.[category] || 0);
  }
  const color = this.categories[category].color;

  this.charts[category] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: this.months,
      // â† ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆé †ã‚’ã€Œå‰å¹´åº¦ â†’ ä»Šå¹´åº¦ã€ã«
      datasets: [
        { // å·¦å´ï¼ˆå‰å¹´åº¦ï¼‰
          label: `${year - 1}å¹´`,
          data: prev,
          backgroundColor: color + '80',
          borderColor: color,
          borderWidth: 1,
          borderRadius: 8,
          borderSkipped: false
        },
        { // å³å´ï¼ˆä»Šå¹´åº¦ï¼‰
          label: `${year}å¹´`,
          data: cur,
          backgroundColor: color,
          borderColor: color,
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: { usePointStyle: true, padding: 20 }
        },
        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã¯ãƒ•ãƒ«é‡‘é¡ï¼ˆå††ï¼‰ã§è¦‹ã›ãŸã„å ´åˆ
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed.y || 0;
              const yen = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(v);
              return `${ctx.dataset.label}: ${yen}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          // â† ç›®ç››ã‚’ã€Œåƒå††ã€è¡¨ç¤ºã«
          ticks: {
            callback: (v) => `${(v / 1000).toLocaleString()} åƒå††`,
            // ãƒ¢ãƒã‚¤ãƒ«ã§æ¨ªå¹…ã‚’ç¢ºä¿ã—ãŸã„å ´åˆã¯ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚‚å°‘ã—å°ã•ã
            // font: (ctx) => (window.innerWidth < 480 ? { size: 10 } : {})
          },
          grid: { color: '#f1f5f9' }
        },
        x: { grid: { display: false } }
      },
      interaction: { intersect: false, mode: 'index' }
    }
  });
}


      hideLoading(){document.getElementById('loadingMessage').style.display='none';document.getElementById('dashboard').style.display='grid';}
      showError(){document.getElementById('loadingMessage').style.display='none';document.getElementById('errorMessage').style.display='block';}
    }

    window.addEventListener('DOMContentLoaded',()=>new HouseholdDashboard());
  </script>
</body>
</html>
